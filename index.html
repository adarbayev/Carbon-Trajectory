<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kömir Zero</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        html { scroll-behavior: smooth; }
        html, body { height: 100%; margin: 0; font-family: 'Inter', sans-serif; background-color: #f0fdfa; /* emerald-50 */ overflow-x: hidden; }
        body { display: flex; flex-direction: column; color: #3f3f46; /* zinc-700 */ }

        /* --- Modal Styles --- */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0s linear 0.3s; }
        .modal-overlay.active { opacity: 1; visibility: visible; transition: opacity 0.3s ease; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 0.5rem; box-shadow: 0 5px 15px rgba(0,0,0,0.2); width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; transform: scale(0.9); transition: transform 0.3s ease; }
        .modal-overlay.active .modal-content { transform: scale(1); }
        .modal-close-btn { position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280; }
        .modal-close-btn:hover { color: #1f2937; }
        .modal-header { font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem; color: #065f46; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.75rem; }
        .modal-footer { margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 0.5rem; }
        .modal-measures-container::-webkit-scrollbar { width: 6px; }
        .modal-measures-container::-webkit-scrollbar-track { background: #d1fae5; border-radius: 10px; }
        .modal-measures-container::-webkit-scrollbar-thumb { background: #6ee7b7; border-radius: 10px; }

        /* --- Home Section Styling --- */
        #home-section { display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; text-align: center; padding: 2rem; position: relative; overflow: hidden; background-color: #ecfdf5; transition: opacity 0.5s ease-in-out, background 0.3s ease-out; }
        #home-section::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #ecfdf5, #d1fae5, #a7f3d0, #d1fae5, #ecfdf5); background-size: 300% 300%; animation: gradientWave 18s ease infinite; z-index: -1; }
        @keyframes gradientWave { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .home-title { font-size: 3rem; font-weight: 800; color: #065f46; margin-bottom: 0.5rem; line-height: 1.1; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); position: relative; }
        .home-subtitle { font-size: 1.125rem; color: #047857; margin-bottom: 2rem; max-width: 600px; position: relative; }
        @media (min-width: 768px) { .home-title { font-size: 4.5rem; } .home-subtitle { font-size: 1.25rem; } }
        .try-tool-btn { background-color: #10b981; color: white; padding: 0.75rem 2rem; border-radius: 0.5rem; font-size: 1.125rem; font-weight: 600; transition: all 0.3s ease-in-out; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); border: none; cursor: pointer; position: relative; }
        .try-tool-btn:hover { background-color: #059669; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); transform: translateY(-2px); }
        .attribution { margin-top: 3rem; font-size: 0.75rem; color: #4b5563; position: relative; display: inline-flex; align-items: center; gap: 0.5rem; }
        .attribution a { color: inherit; text-decoration: none; }
        .attribution a:hover { text-decoration: underline; color: #10b981; }
        .attribution svg { fill: #4b5563; width: 1rem; height: 1rem; transition: fill 0.2s ease; }
        .attribution a:hover svg { fill: #10b981; }

        /* --- Tool Section Styling --- */
        #tool-section { padding: 1rem 0.5rem; flex-grow: 1; margin-top: 1rem; display: block; opacity: 0; visibility: hidden; transition: opacity 0.5s ease-in-out, visibility 0s linear 0.5s; }
        #tool-section.active { opacity: 1; visibility: visible; transition: opacity 0.5s ease-in-out; }
        @media (min-width: 768px) { #tool-section { padding: 2rem; margin-top: 1rem; } }
        .home-button { margin-bottom: 1rem; background-color: #d1fae5; color: #065f46; padding: 0.5rem 1rem; border-radius: 0.375rem; font-size: 0.875rem; font-weight: 500; border: 1px solid #a7f3d0; cursor: pointer; transition: all 0.2s ease; display: inline-block; }
        .home-button:hover { background-color: #a7f3d0; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        /* --- Tab Styling --- */
        .tab-container { position: relative; }
        .tab-button { padding: 0.5rem 1rem; margin-right: 0.5rem; border: 1px solid transparent; border-bottom: none; border-radius: 0.375rem 0.375rem 0 0; cursor: pointer; font-weight: 500; color: #475569; background-color: #f1f5f9; transition: all 0.2s ease-in-out; }
        .tab-button.active { background-color: #ffffff; color: #047857; font-weight: 600; border-color: #cbd5e1; border-bottom-color: #ffffff; }
        .tab-button:not(.active):hover { background-color: #f8fafc; color: #1e293b; }
        .tab-content { border: 1px solid #cbd5e1; border-top: none; padding: 1.5rem; background-color: #ffffff; border-radius: 0 0 0.375rem 0.375rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }

        /* --- Utility & Existing Tool Styles --- */
        .fade-out { opacity: 0; visibility: hidden; transition: opacity 0.5s ease-in-out, visibility 0s linear 0.5s; }
        .hidden { display: none; }
        .chart-container, .macc-chart-container, .wedge-chart-container { position: relative; height: 70vh; width: 100%; background-color: #ffffff; border-radius: 0.5rem; padding: 1rem; border: 1px solid #e2e8f0; }
        .scenario-block { border: 1px solid #a7f3d0; border-radius: 0.75rem; padding: 1.25rem; margin-bottom: 1.5rem; background-color: #ffffff; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .measure-block { border: 1px solid #d1fae5; border-radius: 0.5rem; padding: 1rem; margin-bottom: 1rem; background-color: #ecfdf5; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .remove-btn { background-color: #fecaca; color: #991b1b; padding: 0.3rem 0.6rem; border-radius: 0.375rem; font-size: 0.75rem; font-weight: 600; transition: all 0.2s; border: 1px solid #fca5a5; cursor: pointer; } .remove-btn:hover { background-color: #ef4444; color: white; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); }
        .add-btn { background-color: #34d399; color: #065f46; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s ease-in-out; display: inline-flex; align-items: center; border: 1px solid #6ee7b7; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); cursor: pointer; } .add-btn:hover { background-color: #10b981; color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); transform: translateY(-1px); } .add-btn svg { margin-right: 0.5rem; }
        input[type="number"], input[type="text"], select { border: 1px solid #cbd5e1; border-radius: 0.375rem; padding: 0.6rem; transition: border-color 0.2s, box-shadow 0.2s; width: 100%; box-shadow: inset 0 1px 2px rgba(0,0,0,0.07); } input[type="number"]:focus, input[type="text"]:focus, select:focus { outline: none; border-color: #34d399; box-shadow: 0 0 0 2px rgba(52, 211, 153, 0.4); }
        input:disabled { background-color: #f1f5f9; cursor: not-allowed; }
        .name-input { font-weight: 600; color: #047857; padding: 0.4rem 0.6rem; border: 1px solid transparent; } .name-input:focus { border: 1px solid #34d399; background-color: #ffffff; }
        .section-header { font-size: 1.125rem; font-weight: 600; color: #047857; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 1px solid #a7f3d0; }
        .subsection-header { font-size: 1rem; font-weight: 600; color: #065f46; margin-bottom: 0.75rem; }
        label { font-size: 0.875rem; font-weight: 500; color: #475569; margin-bottom: 0.25rem; display: block; }
        .measure-block input, .measure-block select { padding: 0.4rem; font-size: 0.875rem; }
        .measure-block label { font-size: 0.75rem; margin-bottom: 0.1rem; }
        .edit-btn { background: none; border: none; padding: 0.25rem; color: #059669; cursor: pointer; }
        .edit-btn:hover { color: #047857; text-decoration: underline; }
        /* Button specific styles */
        .modal-footer button { transition: background-color 0.2s ease; }
        .modal-footer button:first-child { background-color: #e2e8f0; color: #475569; } /* Cancel */
        .modal-footer button:first-child:hover { background-color: #cbd5e1; }
        .modal-footer button:last-child { background-color: #059669; } /* Save */
        .modal-footer button:last-child:hover { background-color: #047857; }

    </style>
</head>
<body>

    <section id="home-section">
        <h1 class="home-title">Kömir Zero</h1>
        <p class="home-subtitle">Model your emissions reduction scenarios and analyze costs with MACC analysis.</p>
        <button id="try-tool-btn" class="try-tool-btn">TRY the TRAJECTORY TOOL</button>
        <p class="attribution">
            Built by Anvar Darbayev
            <a href="https://www.linkedin.com/in/anvard/" target="_blank" rel="noopener noreferrer" title="Anvar Darbayev LinkedIn">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4">
                    <path d="M20.5 2h-17A1.5 1.5 0 002 3.5v17A1.5 1.5 0 003.5 22h17a1.5 1.5 0 001.5-1.5v-17A1.5 1.5 0 0020.5 2zM8 19H5v-9h3zM6.5 8.25A1.75 1.75 0 118.3 6.5a1.78 1.78 0 01-1.8 1.75zM19 19h-3v-4.74c0-1.42-.6-1.93-1.38-1.93A1.74 1.74 0 0013 14.19a.66.66 0 000 .14V19h-3v-9h2.9v1.3a3.11 3.11 0 012.7-1.4c1.55 0 3.36.86 3.36 3.66z"></path>
                </svg>
            </a>
        </p>
    </section>

    <section id="tool-section" class="hidden opacity-0">
        <button class="home-button" onclick="showHomePage()">
            &larr; Home
        </button>

        <div class="tab-container mt-4">
            <div class="mb-4 border-b border-gray-200">
                <nav class="-mb-px flex" aria-label="Tabs">
                    <button id="tab-btn-dashboard" class="tab-button active" onclick="switchTab('dashboard')">Trajectory Dashboard</button>
                    <button id="tab-btn-macc" class="tab-button" onclick="switchTab('macc')">MACC Analysis</button>
                    <button id="tab-btn-wedges" class="tab-button" onclick="switchTab('wedges')">Abatement Wedges</button>
                </nav>
            </div>

            <div id="tab-content-dashboard" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8">
                    <div class="lg:col-span-1 bg-white p-0 rounded-lg flex flex-col h-full">
                        <h2 class="section-header">Inputs</h2>
                        <div class="mb-6 border-b border-slate-200 pb-5"> <h3 class="subsection-header flex justify-between items-center"> <span>Baseline</span> <button class="edit-btn text-sm" onclick="openBaselineModal()">Edit Baseline</button> </h3> <div class="grid grid-cols-2 gap-4 mb-4"> <div><label>Total Baseline Emissions</label><div id="baseline-display" class="mt-1 p-2 border border-gray-200 rounded bg-gray-50 text-center font-medium">10000 tCO2eq</div></div> <div><label for="baseline-year">Baseline Year</label><input type="number" id="baseline-year" value="2024" min="2015" max="2050" class="w-full shadow-sm"></div> </div> </div>
                        <div class="mb-6 border-b border-slate-200 pb-5"> <h3 class="subsection-header flex justify-between items-center"> <span>Projections</span> <button class="edit-btn text-sm" onclick="openGrowthRateModal()">Edit Growth Rates</button> </h3> <p class="text-xs text-slate-500 mt-1">Linear growth rates (% of baseline) applied per period.</p> <div class="mt-2 p-2 border border-gray-200 rounded bg-gray-50 text-sm"> <span id="growth-display-p1">P1 (2024-2030): 2.0%</span><br> <span id="growth-display-p2">P2 (2031-2040): 1.5%</span><br> <span id="growth-display-p3">P3 (2041-2050): 1.0%</span> </div> </div>
                        <div class="mb-6 border-b border-slate-200 pb-5"> <h3 class="subsection-header">Target</h3> <div class="flex items-center mb-2"> <input id="sbti-checkbox" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"> <label for="sbti-checkbox" class="ml-2 block text-sm text-gray-900">Align target with SBTi (1.5°C Pathway)?</label> </div> <p id="sbti-note" class="text-xs text-slate-500 mt-1 mb-3 hidden">Applies -42% by near-term target year (baseline+10yrs) and -90% by 2050 vs baseline year emissions.</p> <div><label for="target-reduction">Manual 2050 Target Reduction (%)</label><input type="number" id="target-reduction" value="50" min="0" max="100" class="w-full shadow-sm"></div> </div>
                        <div class="flex-grow flex flex-col"> <div class="flex justify-between items-center mb-4"><h2 class="section-header mb-0 pb-0 border-b-0">Scenarios</h2><button id="add-scenario-btn" class="add-btn"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>Add Scenario</button></div> <div id="scenarios-list" class="flex-grow overflow-y-auto -mr-3 pr-3 space-y-4" style="max-height: calc(70vh - 450px);"></div> </div>
                    </div>
                    <div class="lg:col-span-2 p-0 rounded-lg"> <h2 class="section-header text-center mb-4">Emissions Trajectory (tCO2eq)</h2> <div class="chart-container"><canvas id="trajectoryChart"></canvas></div> <p class="text-xs text-slate-500 mt-4 text-center">*CAPEX and OPEX values are recorded but do not currently affect the emissions trajectory graph.</p> </div>
                </div>
            </div>

            <div id="tab-content-macc" class="tab-content hidden">
                <div class="flex justify-end mb-4">
                    <label for="macc-year-select" class="mr-2 text-sm font-medium text-gray-700 self-center">Analysis Year:</label>
                    <select id="macc-year-select" class="w-24 border border-gray-300 rounded-md shadow-sm p-1.5 text-sm focus:ring-emerald-500 focus:border-emerald-500"></select>
                </div>
                <h2 class="section-header text-center mb-1">Marginal Abatement Cost Curve (MACC)</h2>
                <p id="macc-scenario-info" class="text-sm text-center text-slate-600 mb-4">Analysis based on measures in the first scenario.</p>
                <div class="macc-chart-container">
                    <canvas id="maccChart"></canvas>
                </div>
                <p class="text-xs text-slate-500 mt-4 text-center">
                    *X-axis shows cumulative **annual** abatement potential (tCO2eq/yr) for the selected year. Bar height shows MAC ($/tCO2eq).<br>
                    *Calculations use **annualized** cost ((CAPEX/Lifecycle) + OPEX) and **annual** abatement (Baseline Scope*Reduction%*RampFactor), without discounting.
                </p>
            </div>


            <div id="tab-content-wedges" class="tab-content hidden">
                 <h2 class="section-header text-center mb-1">Abatement Wedges</h2>
                 <p id="wedge-scenario-info" class="text-sm text-center text-slate-600 mb-4">Shows cumulative annual abatement per measure for the first scenario.</p>
                 <div class="wedge-chart-container">
                      <canvas id="wedgeChart"></canvas>
                 </div>
                 <p class="text-xs text-slate-500 mt-4 text-center">*Each colored area represents the annual abatement (tCO2eq/yr) contributed by a specific measure.</p>
            </div>
        </div>

    </section>

    <div id="baseline-modal" class="modal-overlay"> <div class="modal-content relative"> <button class="modal-close-btn" onclick="closeBaselineModal()">&times;</button> <h3 class="modal-header">Edit Baseline Emissions</h3> <div class="space-y-4"> <div><label for="modal-baseline-scope1" class="block text-sm font-medium text-gray-700 mb-1">Scope 1 Emissions (tCO2eq)</label><input type="number" id="modal-baseline-scope1" value="6000" min="0" class="w-full shadow-sm"></div> <div><label for="modal-baseline-scope2" class="block text-sm font-medium text-gray-700 mb-1">Scope 2 Emissions (tCO2eq)</label><input type="number" id="modal-baseline-scope2" value="4000" min="0" class="w-full shadow-sm"></div> </div> <div class="modal-footer"> <button type="button" class="px-4 py-2 bg-white border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50" onclick="closeBaselineModal()">Cancel</button> <button type="button" class="px-4 py-2 bg-indigo-600 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-indigo-700" onclick="saveBaselineModal()">Save Baseline</button> </div> </div> </div>
    <div id="growth-rate-modal" class="modal-overlay"> <div class="modal-content relative"> <button class="modal-close-btn" onclick="closeGrowthRateModal()">&times;</button> <h3 class="modal-header">Edit Growth Rates (% of Baseline / Year)</h3> <div class="space-y-4"> <div> <label id="modal-growth-p1-label" for="modal-growth-p1" class="block text-sm font-medium text-gray-700 mb-1">Period 1 (2024 - 2030)</label> <input type="number" id="modal-growth-p1" value="2.0" step="0.1" class="w-full shadow-sm"> </div> <div> <label for="modal-growth-p2" class="block text-sm font-medium text-gray-700 mb-1">Period 2 (2031 - 2040)</label> <input type="number" id="modal-growth-p2" value="1.5" step="0.1" class="w-full shadow-sm"> </div> <div> <label for="modal-growth-p3" class="block text-sm font-medium text-gray-700 mb-1">Period 3 (2041 - 2050)</label> <input type="number" id="modal-growth-p3" value="1.0" step="0.1" class="w-full shadow-sm"> </div> </div> <div class="modal-footer"> <button type="button" class="px-4 py-2 bg-white border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50" onclick="closeGrowthRateModal()">Cancel</button> <button type="button" class="px-4 py-2 bg-indigo-600 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-indigo-700" onclick="saveGrowthRateModal()">Save Rates</button> </div> </div> </div>
    <div id="measures-modal" class="modal-overlay"> <div class="modal-content relative"> <button class="modal-close-btn" onclick="closeMeasuresModal()">&times;</button> <h3 id="measures-modal-title" class="modal-header">Edit Measures for Scenario</h3> <div id="modal-measures-list" class="modal-measures-container max-h-96 overflow-y-auto pr-2 space-y-4 mb-4"></div> <button id="modal-add-measure-btn" class="add-btn w-full justify-center"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg> Add New Measure </button> <div class="modal-footer"> <button type="button" class="px-4 py-2 bg-indigo-600 border border-transparent rounded-md shadow-sm text-sm font-medium text-white hover:bg-indigo-700" onclick="saveAndCloseMeasuresModal()">Save and Close</button> </div> </div> </div>


    <script>
        // --- DOM Elements ---
        const homeSection = document.getElementById('home-section');
        const toolSection = document.getElementById('tool-section');
        const tryToolBtn = document.getElementById('try-tool-btn');
        const baselineDisplay = document.getElementById('baseline-display');
        const baselineYearInput = document.getElementById('baseline-year');
        const baselineModal = document.getElementById('baseline-modal');
        const modalBaselineScope1 = document.getElementById('modal-baseline-scope1');
        const modalBaselineScope2 = document.getElementById('modal-baseline-scope2');
        const growthRateModal = document.getElementById('growth-rate-modal');
        const modalGrowthP1Label = document.getElementById('modal-growth-p1-label');
        const modalGrowthP1 = document.getElementById('modal-growth-p1');
        const modalGrowthP2 = document.getElementById('modal-growth-p2');
        const modalGrowthP3 = document.getElementById('modal-growth-p3');
        const growthDisplayP1 = document.getElementById('growth-display-p1');
        const growthDisplayP2 = document.getElementById('growth-display-p2');
        const growthDisplayP3 = document.getElementById('growth-display-p3');
        const targetReductionInput = document.getElementById('target-reduction');
        const sbtiCheckbox = document.getElementById('sbti-checkbox');
        const sbtiNote = document.getElementById('sbti-note');
        const addScenarioBtn = document.getElementById('add-scenario-btn');
        const scenariosListContainer = document.getElementById('scenarios-list');
        const measuresModal = document.getElementById('measures-modal');
        const measuresModalTitle = document.getElementById('measures-modal-title');
        const modalMeasuresList = document.getElementById('modal-measures-list');
        const modalAddMeasureBtn = document.getElementById('modal-add-measure-btn');
        const trajectoryCtx = document.getElementById('trajectoryChart').getContext('2d');
        const maccCtx = document.getElementById('maccChart').getContext('2d');
        const wedgeCtx = document.getElementById('wedgeChart').getContext('2d');
        const maccScenarioInfo = document.getElementById('macc-scenario-info');
        const wedgeScenarioInfo = document.getElementById('wedge-scenario-info');
        const maccYearSelect = document.getElementById('macc-year-select'); // MACC Year Selector
        // Tab elements
        const tabBtnDashboard = document.getElementById('tab-btn-dashboard');
        const tabBtnMacc = document.getElementById('tab-btn-macc');
        const tabBtnWedges = document.getElementById('tab-btn-wedges');
        const tabContentDashboard = document.getElementById('tab-content-dashboard');
        const tabContentMacc = document.getElementById('tab-content-macc');
        const tabContentWedges = document.getElementById('tab-content-wedges');

        // --- Global State ---
        let trajectoryChartInstance; let maccChartInstance; let wedgeChartInstance;
        let isToolInitialized = false;
        const scenarioColors = ['#14b8a6', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#6366f1', '#d946ef', '#84cc16'];
        const wedgeColors = [ '#a8ddb5', '#7bccc4', '#4eb3d3', '#2b8cbe', '#0868ac', '#084081', '#fec44f', '#fec44f', '#fe9929', '#d95f0e', '#993404', '#bcbddc', '#efedf5'];
        let scenarioColorIndex = 0; let activeTab = 'dashboard';
        let scenariosDataStore = [];
        let currentEditingScenarioId = null;
        let baselineData = { scope1: 6000, scope2: 4000 };
        let growthRates = { p1: 2.0, p2: 1.5, p3: 1.0 };

        // --- Chart Configurations ---
        const baseTrajectoryChartConfig = { /* ... (unchanged, includes legend hover) ... */
             type: 'line', data: { labels: [], datasets: [ { label: 'Business As Usual (BAU)', data: [], borderColor: '#ef4444', /* red-500 */ backgroundColor: 'rgba(239, 68, 68, 0.1)', tension: 0.1, borderWidth: 2.5, pointBackgroundColor: '#ef4444', pointRadius: 3, pointHoverRadius: 6, fill: false, order: 1 }, { label: 'Target Path', data: [], borderColor: '#3b82f6', /* blue-500 */ backgroundColor: 'rgba(59, 130, 246, 0.1)', tension: 0.1, borderDash: [6, 6], borderWidth: 2.5, pointBackgroundColor: '#3b82f6', pointRadius: 3, pointHoverRadius: 6, fill: false, order: 2 }, { label: 'Near-Term Target Level (-42%)', data: [], borderColor: 'rgba(234, 179, 8, 0.6)', /* yellow-500 */ borderWidth: 1.5, borderDash: [4, 4], pointRadius: 0, fill: false, hidden: true, order: 0 }, { label: 'Long-Term Target Level (-90%)', data: [], borderColor: 'rgba(220, 38, 38, 0.6)', /* red-600 */ borderWidth: 1.5, borderDash: [4, 4], pointRadius: 0, fill: false, hidden: true, order: 0 } ] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { title: { display: true, text: 'Year', font: { size: 14, weight: '500' }, color: '#4b5563' /* gray-600 */ }, grid: { display: false }, ticks: { color: '#6b7280' } }, y: { title: { display: true, text: 'Emissions (tCO2eq)', font: { size: 14, weight: '500' }, color: '#4b5563' }, beginAtZero: true, grid: { color: '#e5e7eb' /* gray-200 */ }, ticks: { color: '#6b7280' } } }, plugins: { tooltip: { mode: 'index', intersect: false, backgroundColor: 'rgba(0, 0, 0, 0.7)', titleFont: { size: 14, weight: '600' }, bodyFont: { size: 12 }, padding: 10, cornerRadius: 4, boxPadding: 5, filter: function(tooltipItem) { return tooltipItem.datasetIndex !== 2 && tooltipItem.datasetIndex !== 3; } }, legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20, font: { size: 13 }, color: '#374151' /* gray-700 */, filter: function(legendItem, chartData) { return !legendItem.hidden; } }, onHover: (event, legendItem, legend) => { const canvas = legend.chart.canvas; if (canvas && legendItem && legendItem.text) { canvas.style.cursor = 'pointer'; } }, onLeave: (event, legendItem, legend) => { const canvas = legend.chart.canvas; if (canvas) { canvas.style.cursor = 'default'; } } } }, interaction: { mode: 'nearest', axis: 'x', intersect: false } }
        };
        // *** MACC Chart Config (Reverted to Categorical for reliability) ***
        const baseMaccChartConfig = {
            type: 'bar',
            data: {
                labels: [], // Measure names
                datasets: [{
                    label: 'MAC ($/tCO2eq)',
                    data: [], // MAC values
                    backgroundColor: '#60a5fa', // blue-400
                    borderColor: '#3b82f6', // blue-500
                    borderWidth: 1,
                    processedMeasures: [] // Store full data for tooltips
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                     x: { type: 'category', title: { display: true, text: 'Abatement Measures (Sorted by Cost)', font: {size: 14, weight: '500'}, color: '#4b5563' } },
                     y: { title: { display: true, text: 'Marginal Abatement Cost ($/tCO2eq)', font: {size: 14, weight: '500'}, color: '#4b5563' } }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            title: function(tooltipItems) { return tooltipItems[0].label || ''; },
                            label: function(context) {
                                const measures = context.chart.data.datasets[0].processedMeasures;
                                const index = context.dataIndex;
                                const measure = measures && measures[index] ? measures[index] : null;
                                return measure ? `MAC: $${measure.mac.toFixed(2)} / tCO2eq` : '';
                            },
                            footer: function(tooltipItems) {
                                const measures = tooltipItems[0].chart.data.datasets[0].processedMeasures;
                                const index = tooltipItems[0].dataIndex;
                                const measure = measures && measures[index] ? measures[index] : null;
                                if (measure) {
                                    // Show annual abatement for the selected year in the tooltip
                                    return [
                                        `Annual Abatement (${maccYearSelect.value}): ${measure.annualAbatementForSelectedYear.toFixed(0)} tCO2eq/yr`,
                                        `Annualized Cost: $${measure.annualizedCost.toFixed(0)} /yr`
                                    ];
                                } return '';
                            }
                        }
                    },
                    legend: { display: false }
                }
            }
        };
        const baseWedgeChartConfig = { /* ... (unchanged) ... */
            type: 'line', data: { labels: [], datasets: [] }, options: { responsive: true, maintainAspectRatio: false, scales: { x: { title: { display: true, text: 'Year', font: { size: 14, weight: '500' }, color: '#4b5563' } }, y: { stacked: true, title: { display: true, text: 'Cumulative Annual Abatement (tCO2eq/yr)', font: { size: 14, weight: '500' }, color: '#4b5563' }, beginAtZero: true } }, plugins: { tooltip: { mode: 'index', intersect: false, callbacks: { label: function(context) { let label = context.dataset.label || ''; if (label) { label += ': '; } let currentValue = context.parsed.y; if (currentValue !== null) { label += `${currentValue.toFixed(0)} tCO2eq/yr (Cumulative)`; } return label; } } }, legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20, font: { size: 13 }, color: '#374151' } } }, interaction: { mode: 'nearest', axis: 'x', intersect: false } }
        };

        // --- Modal Management ---
        function openBaselineModal() { /* ... (unchanged) ... */
            modalBaselineScope1.value = baselineData.scope1;
            modalBaselineScope2.value = baselineData.scope2;
            baselineModal.classList.add('active');
        }
        function closeBaselineModal() { /* ... (unchanged) ... */
            baselineModal.classList.remove('active');
        }
        function saveBaselineModal() { /* ... (unchanged) ... */
            baselineData.scope1 = parseFloat(modalBaselineScope1.value) || 0;
            baselineData.scope2 = parseFloat(modalBaselineScope2.value) || 0;
            const totalBaseline = baselineData.scope1 + baselineData.scope2;
            baselineDisplay.textContent = `${totalBaseline.toFixed(0)} tCO2eq`;
            closeBaselineModal();
            if (isToolInitialized) debouncedCalculateAllData();
        }
        function openGrowthRateModal() { /* ... (unchanged) ... */
            const baselineYear = parseInt(baselineYearInput.value) || new Date().getFullYear();
            modalGrowthP1Label.textContent = `Period 1 (${baselineYear} - 2030)`;
            modalGrowthP1.value = growthRates.p1.toFixed(1);
            modalGrowthP2.value = growthRates.p2.toFixed(1);
            modalGrowthP3.value = growthRates.p3.toFixed(1);
            growthRateModal.classList.add('active');
        }
        function closeGrowthRateModal() { /* ... (unchanged) ... */
            growthRateModal.classList.remove('active');
        }
        function saveGrowthRateModal() { /* ... (unchanged) ... */
            growthRates.p1 = parseFloat(modalGrowthP1.value) || 0;
            growthRates.p2 = parseFloat(modalGrowthP2.value) || 0;
            growthRates.p3 = parseFloat(modalGrowthP3.value) || 0;
            updateGrowthRateDisplay();
            closeGrowthRateModal();
            if (isToolInitialized) debouncedCalculateAllData();
        }
        function updateGrowthRateDisplay() { /* ... (unchanged) ... */
            const baselineYear = parseInt(baselineYearInput.value) || new Date().getFullYear();
            growthDisplayP1.textContent = `P1 (${baselineYear}-2030): ${growthRates.p1.toFixed(1)}%`;
            growthDisplayP2.textContent = `P2 (2031-2040): ${growthRates.p2.toFixed(1)}%`;
            growthDisplayP3.textContent = `P3 (2041-2050): ${growthRates.p3.toFixed(1)}%`;
        }

        function openMeasuresModal(scenarioId) { /* ... (unchanged) ... */
            currentEditingScenarioId = scenarioId;
            const scenario = scenariosDataStore.find(s => s.id === scenarioId);
            if (!scenario) { console.error("Scenario not found for editing:", scenarioId); return; }
            measuresModalTitle.textContent = `Edit Measures for ${scenario.name}`;
            modalMeasuresList.innerHTML = '';
            const measuresToEdit = JSON.parse(JSON.stringify(scenario.measures));
            measuresToEdit.forEach(measure => { modalMeasuresList.appendChild(createMeasureBlockElement(measure)); });
            measuresModal.classList.add('active');
        }
        function closeMeasuresModal() { /* ... (unchanged) ... */
            currentEditingScenarioId = null;
            measuresModal.classList.remove('active');
        }
        function saveAndCloseMeasuresModal() { /* ... (unchanged) ... */
            if (!currentEditingScenarioId) { console.log("Save cancelled: No scenario ID being edited."); closeMeasuresModal(); return; }
            const scenarioIndex = scenariosDataStore.findIndex(s => s.id === currentEditingScenarioId);
            if (scenarioIndex === -1) { console.error("Scenario to save not found in store:", currentEditingScenarioId); closeMeasuresModal(); return; }
            console.log(`Saving measures for scenario ID: ${currentEditingScenarioId}, Index: ${scenarioIndex}`);
            const updatedMeasures = [];
            const measureBlocksInModal = modalMeasuresList.querySelectorAll('.measure-block');
            console.log(`Found ${measureBlocksInModal.length} measure blocks in modal.`);
            measureBlocksInModal.forEach((block, index) => {
                 try {
                     const nameInput = block.querySelector('.measure-name-input');
                     const name = nameInput ? nameInput.value.trim() || `Measure ${index + 1}` : `Measure ${index + 1}`;
                     const reductionEl = block.querySelector('.measure-reduction');
                     const reduction = reductionEl ? parseFloat(reductionEl.value) || 0 : 0;
                     const permanentEl = block.querySelector('.measure-permanent');
                     const isPermanent = permanentEl ? permanentEl.value === 'yes' : false;
                     const lifecycleInput = block.querySelector('.measure-lifecycle');
                     let lifecycle = 1;
                     if (isPermanent) { lifecycle = 99; } else if (lifecycleInput) { lifecycle = parseInt(lifecycleInput.value) || 1; }
                     lifecycle = Math.max(1, lifecycle);
                     const instantEl = block.querySelector('.measure-instant');
                     const isInstant = instantEl ? instantEl.value === 'yes' : true;
                     const rampInput = block.querySelector('.measure-ramp');
                     let rampYears = 1;
                     if (!isInstant && rampInput) { rampYears = parseInt(rampInput.value) || 1; }
                     rampYears = Math.max(1, rampYears);
                     const startYearEl = block.querySelector('.measure-start-year');
                     const startYear = startYearEl ? parseInt(startYearEl.value) || (parseInt(baselineYearInput.value) || 1990) : (parseInt(baselineYearInput.value) || 1990);
                     const scopeEl = block.querySelector('.measure-scope');
                     const scope = scopeEl ? scopeEl.value : 'Scope 1';
                     const capexEl = block.querySelector('.measure-capex');
                     const capex = capexEl ? parseFloat(capexEl.value) || 0 : 0;
                     const opexEl = block.querySelector('.measure-opex');
                     const opex = opexEl ? parseFloat(opexEl.value) || 0 : 0;
                     const measureData = { id: block.id || `measure-${Date.now()}-${index}`, name, reduction, isPermanent, lifecycle, isInstant, rampYears, startYear, scope, capex, opex };
                     console.log(`Read measure ${index + 1}:`, measureData);
                     if (measureData.reduction > 0 && measureData.reduction <= 100 && measureData.lifecycle > 0 && measureData.startYear >= (parseInt(baselineYearInput.value) || 1990) && measureData.startYear <= 2050) {
                         updatedMeasures.push(measureData);
                     } else { console.warn("Skipping invalid measure data during modal save:", measureData); }
                 } catch (error) { console.error(`Error reading data for measure block ${index}:`, error, block); }
            });
            scenariosDataStore[scenarioIndex].measures = updatedMeasures;
            console.log("Updated scenariosDataStore:", JSON.stringify(scenariosDataStore));
            const scenarioBlockOnPage = document.getElementById(currentEditingScenarioId);
            if (scenarioBlockOnPage) { const countElement = scenarioBlockOnPage.querySelector('.text-xs'); if (countElement) { countElement.textContent = `${updatedMeasures.length} measure(s)`; } }
            closeMeasuresModal();
            if (isToolInitialized) { console.log("Triggering recalculation after saving measures..."); debouncedCalculateAllData(); }
        }

        // --- Calculation & Data ---
        // *** Updated MACC Calculation Logic ***
        function calculateAllData() {
             if (!isToolInitialized) return;
             console.log("[calculateAllData] Starting calculation...");
             const totalBaselineEmissions = baselineData.scope1 + baselineData.scope2;
             const baselineYear = parseInt(baselineYearInput.value) || new Date().getFullYear();
             const isSBTiAligned = sbtiCheckbox.checked;
             const manualTargetReduction = Math.max(0, Math.min(100, parseFloat(targetReductionInput.value))) / 100 || 0;
             const endYear = 2050;
             const nearTermTargetYear = baselineYear + 10;
             const years = []; const bauEmissions = []; const targetEmissions = [];
             let sbtiNearTermLevel = null;
             let sbtiLongTermLevel = null;

             if (totalBaselineEmissions <= 0 || baselineYear > endYear || baselineYear < 2015) { console.error("[calculateAllData] Invalid baseline inputs. Clearing charts."); updateTrajectoryChart(years, bauEmissions, targetEmissions, [], null, null); updateMaccChart([]); updateWedgeChart(years, []); return; }
             let useSBTiLogic = isSBTiAligned;
             if (isSBTiAligned && nearTermTargetYear > 2050) { console.warn(`[calculateAllData] SBTi alignment selected, but Near-Term Target Year (${nearTermTargetYear}) is beyond 2050. Reverting to manual target.`); sbtiCheckbox.checked = false; targetReductionInput.disabled = false; sbtiNote.classList.add('hidden'); useSBTiLogic = false; }

             // Calculate BAU
             let currentBauEmissions = totalBaselineEmissions;
             for (let year = baselineYear; year <= endYear; year++) {
                 years.push(year);
                 if (year === baselineYear) { bauEmissions.push(currentBauEmissions); }
                 else { let applicableGrowthRate = 0; if (year <= 2030) { applicableGrowthRate = growthRates.p1 / 100; } else if (year <= 2040) { applicableGrowthRate = growthRates.p2 / 100; } else { applicableGrowthRate = growthRates.p3 / 100; } const annualIncrease = totalBaselineEmissions * applicableGrowthRate; currentBauEmissions += annualIncrease; bauEmissions.push(Math.max(0, currentBauEmissions)); }
             }

             // Calculate Target Path
             if (useSBTiLogic) {
                 sbtiNearTermLevel = totalBaselineEmissions * (1 - 0.42); sbtiLongTermLevel = totalBaselineEmissions * (1 - 0.90); console.log(`[calculateAllData] SBTi Targets: Near-Term Year=${nearTermTargetYear}, Level=${sbtiNearTermLevel}, 2050 Level=${sbtiLongTermLevel}`);
                 for (let i = 0; i < years.length; i++) { const year = years[i]; if (year === baselineYear) { targetEmissions.push(totalBaselineEmissions); } else if (year <= nearTermTargetYear) { const yearsToNearTerm = nearTermTargetYear - baselineYear; const progressRatio = yearsToNearTerm > 0 ? Math.max(0, Math.min(1, (year - baselineYear) / yearsToNearTerm)) : 1; const linearTarget = totalBaselineEmissions + (sbtiNearTermLevel - totalBaselineEmissions) * progressRatio; targetEmissions.push(Math.max(0, linearTarget)); } else { const yearsTo2050 = endYear - nearTermTargetYear; const nearTermIndex = years.indexOf(nearTermTargetYear); const startLevel = (nearTermIndex !== -1 && targetEmissions[nearTermIndex] !== undefined) ? targetEmissions[nearTermIndex] : sbtiNearTermLevel; const progressRatio = yearsTo2050 > 0 ? Math.max(0, Math.min(1, (year - nearTermTargetYear) / yearsTo2050)) : 1; const linearTarget = startLevel + (sbtiLongTermLevel - startLevel) * progressRatio; targetEmissions.push(Math.max(0, linearTarget)); } }
             } else {
                 console.log(`[calculateAllData] Using Manual Target Reduction: ${manualTargetReduction * 100}%`); const targetEmission2050 = totalBaselineEmissions * (1 - manualTargetReduction); const finalTarget = Math.max(0, targetEmission2050);
                 for (let i = 0; i < years.length; i++) { const year = years[i]; if (year === baselineYear) { targetEmissions.push(totalBaselineEmissions); } else { const yearsTotal = endYear - baselineYear; const progressRatio = yearsTotal > 0 ? Math.max(0, Math.min(1,(year - baselineYear) / yearsTotal)) : 1; const linearTarget = totalBaselineEmissions + (finalTarget - totalBaselineEmissions) * progressRatio; targetEmissions.push(Math.max(0, linearTarget)); } }
             }

             // Calculate Scenarios & Wedge Data
             const scenariosData = getAllScenariosData();
             const scenarioTrajectories = [];
             const wedgeDatasets = [];

             if (scenariosData.length > 0) {
                 const firstScenario = scenariosData[0];
                 wedgeScenarioInfo.textContent = `Abatement breakdown for scenario: "${firstScenario.name}"`;

                 // Prepare wedge datasets
                 firstScenario.measures.forEach((measure, measureIndex) => {
                     wedgeDatasets.push({
                         label: measure.name, data: [],
                         backgroundColor: `${wedgeColors[measureIndex % wedgeColors.length]}B3`,
                         borderColor: wedgeColors[measureIndex % wedgeColors.length],
                         borderWidth: 0.5, pointRadius: 0, fill: true, order: measureIndex
                     });
                 });

                 // Calculate scenario trajectory and individual measure abatement per year
                 const scenarioEmissionValues = [];
                 for (let i = 0; i < years.length; i++) {
                     const currentYear = years[i];
                     const currentBau = bauEmissions[i];
                     let totalYearlyReduction = 0;
                     let cumulativeAbatementForYear = 0;

                     firstScenario.measures.forEach((measure, measureIndex) => {
                         const endMeasureYear = measure.startYear + measure.lifecycle - 1;
                         let absoluteAnnualAbatement = 0;

                         if (currentYear >= measure.startYear && currentYear <= endMeasureYear) {
                             const yrsIn = currentYear - measure.startYear + 1;
                             const rampYears = Math.max(1, measure.rampYears || 1);
                             const rampFactor = Math.min(1, yrsIn / rampYears);
                             const effectiveReductionPercent = (measure.reduction / 100) * rampFactor;
                             let relevantBaseline = 0;
                             if (measure.scope === 'Scope 1') { relevantBaseline = baselineData.scope1 || 0; }
                             else if (measure.scope === 'Scope 2') { relevantBaseline = baselineData.scope2 || 0; }
                             absoluteAnnualAbatement = (relevantBaseline > 1e-9 ? relevantBaseline : 0) * effectiveReductionPercent;
                         }
                         cumulativeAbatementForYear += absoluteAnnualAbatement;
                         if (wedgeDatasets[measureIndex]) {
                             wedgeDatasets[measureIndex].data.push(cumulativeAbatementForYear);
                         }
                         totalYearlyReduction += absoluteAnnualAbatement;
                     });
                     scenarioEmissionValues.push(Math.max(0, currentBau - totalYearlyReduction));
                 }
                  if (scenariosDataStore.length > 0) {
                     scenarioTrajectories.push({ name: firstScenario.name, color: firstScenario.color, data: scenarioEmissionValues });
                     updateTrajectoryChart(years, bauEmissions, targetEmissions, scenarioTrajectories, useSBTiLogic ? sbtiNearTermLevel : null, useSBTiLogic ? sbtiLongTermLevel : null);
                  }

             } else {
                 wedgeScenarioInfo.textContent = "Add a scenario and measures to see abatement wedges.";
                 updateTrajectoryChart(years, bauEmissions, targetEmissions, [], useSBTiLogic ? sbtiNearTermLevel : null, useSBTiLogic ? sbtiLongTermLevel : null);
             }

             // Calculate MACC Data for the *selected* year
             const selectedMaccYear = parseInt(maccYearSelect.value) || baselineYear + 1;
             let processedMaccData = [];
             if (scenariosDataStore.length > 0 && scenariosDataStore[0].measures.length > 0) {
                  const firstScenario = scenariosDataStore[0];
                  maccScenarioInfo.textContent = `Analysis based on measures in scenario: "${firstScenario.name}" for year ${selectedMaccYear}`;

                  processedMaccData = firstScenario.measures.map(measure => {
                      const lifecycle = measure.lifecycle;
                      const reductionPercent = measure.reduction / 100;
                      let relevantBaseline = 0;
                      if (measure.scope === 'Scope 1') { relevantBaseline = baselineData.scope1 || 0; }
                      else if (measure.scope === 'Scope 2') { relevantBaseline = baselineData.scope2 || 0; }
                      const validBaseline = relevantBaseline > 1e-9 ? relevantBaseline : 1e-9;

                      // Calculate abatement *for the selected year*
                      let absoluteAnnualAbatementForSelectedYear = 0;
                      const endMeasureYear = measure.startYear + measure.lifecycle - 1;
                      if (selectedMaccYear >= measure.startYear && selectedMaccYear <= endMeasureYear) {
                            const yrsIn = selectedMaccYear - measure.startYear + 1;
                            const rampYears = Math.max(1, measure.rampYears || 1);
                            const rampFactor = Math.min(1, yrsIn / rampYears);
                            const effectiveReductionPercent = reductionPercent * rampFactor;
                            absoluteAnnualAbatementForSelectedYear = validBaseline * effectiveReductionPercent;
                      }

                      const annualizedCapex = (lifecycle > 0) ? measure.capex / lifecycle : measure.capex;
                      const annualizedCost = annualizedCapex + measure.opex;
                      const mac = (absoluteAnnualAbatementForSelectedYear > 1e-9) ? annualizedCost / absoluteAnnualAbatementForSelectedYear : Infinity;

                      if (absoluteAnnualAbatementForSelectedYear <= 1e-9 || !isFinite(mac) || !isFinite(annualizedCost)) return null;
                      return { ...measure, annualAbatementForSelectedYear, annualizedCost, mac }; // Removed scope here as it's not needed for MACC display itself
                  }).filter(m => m !== null);
                  processedMaccData.sort((a, b) => a.mac - b.mac);
             } else {
                  maccScenarioInfo.textContent = "Add measures to the first scenario to see MACC analysis.";
             }
             updateMaccChart(processedMaccData, selectedMaccYear); // Pass selected year
             updateWedgeChart(years, wedgeDatasets);
        }


        function getAllScenariosData() { /* ... (unchanged) ... */
            console.log("[getAllScenariosData] Reading from scenariosDataStore:", JSON.stringify(scenariosDataStore));
            return JSON.parse(JSON.stringify(scenariosDataStore)); // Return a deep copy
        }

        // --- Chart Update Functions ---
        function updateTrajectoryChart(years, bauData, targetData, scenarioTrajectories, nearTermTargetLevel, longTermTargetLevel) { /* ... (unchanged logic, standard legend filter) ... */
            if (!trajectoryCtx) { console.error("Trajectory Chart context not found!"); return; }
            if (trajectoryChartInstance) { trajectoryChartInstance.destroy(); }
            const newChartConfig = JSON.parse(JSON.stringify(baseTrajectoryChartConfig));
            newChartConfig.data.labels = years;
            newChartConfig.data.datasets[0].data = bauData;
            newChartConfig.data.datasets[1].data = targetData;
            const showSBTiLines = nearTermTargetLevel !== null && longTermTargetLevel !== null;
            console.log(`[updateTrajectoryChart] showSBTiLines = ${showSBTiLines}`);
            newChartConfig.data.datasets[2].data = showSBTiLines ? years.map(() => nearTermTargetLevel) : [];
            newChartConfig.data.datasets[2].hidden = !showSBTiLines;
            newChartConfig.data.datasets[3].data = showSBTiLines ? years.map(() => longTermTargetLevel) : [];
            newChartConfig.data.datasets[3].hidden = !showSBTiLines;
            newChartConfig.data.datasets = newChartConfig.data.datasets.slice(0, 4);
            // Only add the first scenario's trajectory here for simplicity in this view
            if (scenarioTrajectories.length > 0) {
                 const firstScenarioTraj = scenarioTrajectories[0];
                 newChartConfig.data.datasets.push({ label: firstScenarioTraj.name, data: firstScenarioTraj.data, borderColor: firstScenarioTraj.color, backgroundColor: `${firstScenarioTraj.color}33`, tension: 0.1, borderWidth: 2.5, pointBackgroundColor: firstScenarioTraj.color, pointRadius: 3, pointHoverRadius: 6, fill: false, order: 3 });
            }
            // Ensure legend filter is set correctly
            newChartConfig.options.plugins.legend.labels.filter = function(legendItem, chartData) { const dataset = chartData.datasets[legendItem.datasetIndex]; return dataset && !dataset.hidden; };
            newChartConfig.options.plugins.tooltip.filter = function(tooltipItem) { return tooltipItem.datasetIndex !== 2 && tooltipItem.datasetIndex !== 3; };
            console.log("[updateTrajectoryChart] Final datasets count:", newChartConfig.data.datasets.length);
            console.log("[updateTrajectoryChart] Final datasets config (Hidden Status):", JSON.stringify(newChartConfig.data.datasets.map(ds => ({label: ds.label, hidden: ds.hidden}))));
            try { trajectoryChartInstance = new Chart(trajectoryCtx, newChartConfig); console.log("[updateTrajectoryChart] Trajectory chart updated."); } catch(error) { console.error("[updateTrajectoryChart] Error creating trajectory chart:", error); }
        }

        // *** Updated MACC Chart Update Function for Floating Bars ***
        function updateMaccChart(processedMaccData, selectedYear) {
            if (!maccCtx) { console.error("MACC Chart context (maccCtx) not found!"); return; }
            if (maccChartInstance) { maccChartInstance.destroy(); }
            console.log(`[updateMaccChart] Updating MACC for year ${selectedYear} with data count:`, processedMaccData.length);

            const newChartConfig = JSON.parse(JSON.stringify(baseMaccChartConfig)); // Use the correct base config

            let cumulativeAnnualAbatement = 0;
            const chartDataPoints = [];
            const measureLabels = []; // Store names for tooltips

            processedMaccData.forEach(measure => {
                const startCumulative = cumulativeAnnualAbatement;
                // Ensure abatement is positive before adding
                if (measure.annualAbatementForSelectedYear > 0) {
                    cumulativeAnnualAbatement += measure.annualAbatementForSelectedYear;
                } else {
                    console.warn(`[updateMaccChart] Measure ${measure.name} has zero/negative abatement for ${selectedYear}, skipping.`);
                    return; // Skip measures with no abatement in the selected year
                }
                // Ensure data is valid before pushing
                if (isFinite(startCumulative) && isFinite(cumulativeAnnualAbatement) && cumulativeAnnualAbatement > startCumulative && isFinite(measure.mac)) {
                     chartDataPoints.push({
                         x: [startCumulative, cumulativeAnnualAbatement],
                         y: measure.mac
                     });
                     measureLabels.push(measure.name); // Keep track of name for tooltips
                } else {
                    console.warn(`[updateMaccChart] Skipping measure ${measure.name} due to invalid chart data point: x=[${startCumulative}, ${cumulativeAnnualAbatement}], y=${measure.mac}`);
                }
            });

            if (chartDataPoints.length === 0) {
                console.log("[updateMaccChart] No valid data points to plot.");
                 maccScenarioInfo.textContent = `No valid measures found for MACC analysis in ${selectedYear}.`;
                 newChartConfig.data.labels = [];
                 newChartConfig.data.datasets[0].data = [];
                 newChartConfig.data.datasets[0].processedMeasures = [];
            } else {
                newChartConfig.data.labels = measureLabels; // Use names for tooltip titles
                newChartConfig.data.datasets[0].data = chartDataPoints; // Assign floating bar data
                newChartConfig.data.datasets[0].processedMeasures = processedMaccData; // Store full data for tooltips
                 const scenarioName = scenariosDataStore.length > 0 ? scenariosDataStore[0].name : "Scenario 1";
                 maccScenarioInfo.textContent = `Analysis based on measures in scenario: "${scenarioName}" for year ${selectedYear}`;
                 // Update x-axis title
                 newChartConfig.options.scales.x.title.text = `Cumulative Annual Abatement (tCO2eq/yr for ${selectedYear})`;
            }

            const barColors = processedMaccData.map(() => '#60a5fa'); // blue-400
            newChartConfig.data.datasets[0].backgroundColor = barColors;
            newChartConfig.data.datasets[0].borderColor = barColors.map(c => '#3b82f6'); // blue-500

            console.log("[updateMaccChart] Final Chart Config Data:", JSON.stringify(newChartConfig.data));

            try {
                maccChartInstance = new Chart(maccCtx, newChartConfig);
                console.log("[updateMaccChart] New MACC chart instance created successfully.");
            } catch (error) {
                console.error("[updateMaccChart] Error creating MACC chart:", error);
                maccScenarioInfo.textContent = "Error displaying MACC chart. Check console for details.";
            }
        }


        function updateWedgeChart(years, wedgeDatasets) { /* ... (unchanged) ... */
             if (!wedgeCtx) { console.error("Wedge Chart context (wedgeCtx) not found!"); return; }
             if (wedgeChartInstance) { wedgeChartInstance.destroy(); }
             console.log("[updateWedgeChart] Updating Wedge chart with dataset count:", wedgeDatasets.length);
             const newChartConfig = JSON.parse(JSON.stringify(baseWedgeChartConfig));
             newChartConfig.data.labels = years;
             newChartConfig.data.datasets = wedgeDatasets;
             if (wedgeDatasets.length === 0) { wedgeScenarioInfo.textContent = "Add measures to the first scenario to see abatement wedges."; } else { const scenarioName = scenariosDataStore.length > 0 ? scenariosDataStore[0].name : "Scenario 1"; wedgeScenarioInfo.textContent = `Abatement breakdown for scenario: "${scenarioName}"`; }
             console.log("[updateWedgeChart] Final Wedge Chart Config Data:", JSON.stringify(newChartConfig.data));
             try { wedgeChartInstance = new Chart(wedgeCtx, newChartConfig); console.log("[updateWedgeChart] New Wedge chart instance created successfully."); } catch (error) { console.error("[updateWedgeChart] Error creating Wedge chart:", error); wedgeScenarioInfo.textContent = "Error displaying Abatement Wedges chart. Check console for details."; }
         }


        // --- Event Listeners & Debounce ---
        function debounce(func, wait) { let timeout; return function executedFunction(...args) { const later = () => { clearTimeout(timeout); func(...args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); }; }
        const debouncedCalculateAllData = debounce(calculateAllData, 350);
        // --- Scenario & Measure Management ---
        function addScenario() { /* ... (unchanged) ... */
            const scenarioId = `scenario-${Date.now()}`; const scenarioCount = scenariosDataStore.length + 1; const defaultScenarioName = `Scenario ${scenarioCount}`; const color = scenarioColors[scenarioColorIndex % scenarioColors.length]; scenarioColorIndex++;
            const newScenarioData = { id: scenarioId, name: defaultScenarioName, color: color, measures: [] }; scenariosDataStore.push(newScenarioData);
            const scenarioBlock = createScenarioBlockElement(newScenarioData); scenariosListContainer.appendChild(scenarioBlock);
            if(isToolInitialized) calculateAllData();
        }
        function createScenarioBlockElement(scenarioData) { /* ... (unchanged) ... */
             const scenarioBlock = document.createElement('div'); scenarioBlock.classList.add('scenario-block'); scenarioBlock.id = scenarioData.id; scenarioBlock.dataset.color = scenarioData.color;
             scenarioBlock.innerHTML = `<div class="flex justify-between items-center mb-3"><input type="text" value="${scenarioData.name}" placeholder="Scenario Name" class="scenario-name-input name-input flex-grow mr-3 text-lg" oninput="updateScenarioName('${scenarioData.id}', this.value)"><div class="flex items-center gap-2"><button type="button" class="edit-btn text-sm" onclick="openMeasuresModal('${scenarioData.id}')">Edit Measures</button><button type="button" class="remove-btn" onclick="deleteScenario('${scenarioData.id}')">Delete</button></div></div><p class="text-xs text-gray-500">${scenarioData.measures.length} measure(s)</p>`;
             return scenarioBlock;
        }
        // *** Make sure onclick functions are globally accessible ***
        window.updateScenarioName = updateScenarioName;
        window.deleteScenario = deleteScenario;
        window.openMeasuresModal = openMeasuresModal;
        window.removeMeasureInModal = removeMeasureInModal;
        window.toggleLifecycleInput = toggleLifecycleInput;
        window.toggleRampYearsInput = toggleRampYearsInput;
        window.switchTab = switchTab;
        window.showHomePage = showHomePage;
        window.openBaselineModal = openBaselineModal;
        window.closeBaselineModal = closeBaselineModal;
        window.saveBaselineModal = saveBaselineModal;
        window.openGrowthRateModal = openGrowthRateModal;
        window.closeGrowthRateModal = closeGrowthRateModal;
        window.saveGrowthRateModal = saveGrowthRateModal;
        window.closeMeasuresModal = closeMeasuresModal;
        window.saveAndCloseMeasuresModal = saveAndCloseMeasuresModal;


        function updateScenarioName(scenarioId, newName) { /* ... (unchanged, but adjusted index) ... */
            const scenario = scenariosDataStore.find(s => s.id === scenarioId); if (scenario) { scenario.name = newName.trim() || "Unnamed Scenario"; if (scenariosDataStore.length > 0 && scenariosDataStore[0].id === scenarioId) { maccScenarioInfo.textContent = `Analysis based on measures in scenario: "${scenario.name}"`; wedgeScenarioInfo.textContent = `Abatement breakdown for scenario: "${scenario.name}"`; } if (trajectoryChartInstance) { const datasetIndex = scenariosDataStore.findIndex(s => s.id === scenarioId); const chartDatasetIndex = datasetIndex + 4; if (datasetIndex !== -1 && trajectoryChartInstance.data.datasets[chartDatasetIndex]) { trajectoryChartInstance.data.datasets[chartDatasetIndex].label = scenario.name; trajectoryChartInstance.update('none'); } } }
        }
        function deleteScenario(scenarioId) { /* ... (unchanged) ... */
            scenariosDataStore = scenariosDataStore.filter(s => s.id !== scenarioId); const scenarioBlock = document.getElementById(scenarioId); if (scenarioBlock) scenarioBlock.remove(); if(isToolInitialized) calculateAllData();
        }

        // *** Updated createMeasureBlockElement with Ramp-up ***
        function createMeasureBlockElement(measureData = {}) {
            const measureId = measureData.id || `measure-${Date.now()}-${Math.random().toString(16).slice(2)}`;
            const measureBlock = document.createElement('div');
            measureBlock.classList.add('measure-block');
            measureBlock.id = measureId;

            const name = measureData.name || `New Measure`;
            const reduction = measureData.reduction || 5;
            const isPermanent = measureData.isPermanent || false;
            const lifecycle = measureData.lifecycle || 10;
            const isInstant = measureData.isInstant === undefined ? true : measureData.isInstant; // Default to instant
            const rampYears = measureData.rampYears || 1;
            const startYear = measureData.startYear || (parseInt(baselineYearInput.value) + 1 || new Date().getFullYear() + 1);
            const scope = measureData.scope || 'Scope 1';
            const capex = measureData.capex || 100000;
            const opex = measureData.opex || 5000;

            measureBlock.innerHTML = `
                <div class="flex justify-between items-center mb-3">
                     <input type="text" value="${name}" placeholder="Measure Name" class="measure-name-input name-input flex-grow mr-2 text-sm">
                     <button type="button" class="remove-btn text-xs" onclick="removeMeasureInModal('${measureId}')">Remove</button>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-x-3 gap-y-2"> <div>
                        <label class="block text-xs font-medium text-gray-600">Reduction (%)</label>
                        <input type="number" value="${reduction}" min="0" max="100" step="0.1" class="measure-reduction w-full">
                    </div>
                     <div>
                        <label class="block text-xs font-medium text-gray-600">Scope</label>
                        <select class="measure-scope w-full">
                            <option value="Scope 1" ${scope === 'Scope 1' ? 'selected' : ''}>Scope 1</option>
                            <option value="Scope 2" ${scope === 'Scope 2' ? 'selected' : ''}>Scope 2</option>
                        </select>
                    </div>
                     <div>
                        <label class="block text-xs font-medium text-gray-600">Start Year</label>
                        <input type="number" value="${startYear}" min="${baselineYearInput.value || 1990}" max="2050" class="measure-start-year w-full">
                    </div>
                     <div>
                        <label class="block text-xs font-medium text-gray-600">Permanent?</label>
                        <select class="measure-permanent w-full" onchange="toggleLifecycleInput(this, '${measureId}')">
                            <option value="no" ${!isPermanent ? 'selected' : ''}>No</option>
                            <option value="yes" ${isPermanent ? 'selected' : ''}>Yes</option>
                        </select>
                    </div>
                     <div class="lifecycle-input-container ${isPermanent ? 'hidden' : ''}">
                        <label class="block text-xs font-medium text-gray-600">Lifecycle (yrs)</label>
                        <input type="number" value="${lifecycle}" min="1" class="measure-lifecycle w-full">
                    </div>
                     <div>
                        <label class="block text-xs font-medium text-gray-600">Instant Effect?</label>
                        <select class="measure-instant w-full" onchange="toggleRampYearsInput(this, '${measureId}')">
                            <option value="yes" ${isInstant ? 'selected' : ''}>Yes</option>
                            <option value="no" ${!isInstant ? 'selected' : ''}>No</option>
                        </select>
                    </div>
                     <div class="ramp-years-input-container ${isInstant ? 'hidden' : ''}">
                        <label class="block text-xs font-medium text-gray-600">Ramp-up (yrs)</label>
                        <input type="number" value="${rampYears}" min="1" step="1" class="measure-ramp w-full">
                    </div>
                     <div>
                        <label class="block text-xs font-medium text-gray-600">CAPEX ($)</label>
                        <input type="number" value="${capex}" min="0" step="1000" class="measure-capex w-full">
                    </div>
                     <div>
                        <label class="block text-xs font-medium text-gray-600">OPEX ($/yr)</label>
                        <input type="number" value="${opex}" min="0" step="100" class="measure-opex w-full">
                    </div>
                </div>
            `;
            return measureBlock;
        }


        function addMeasureInModal() { /* ... (unchanged) ... */
            if (!currentEditingScenarioId) return;
            const newMeasureBlock = createMeasureBlockElement();
            modalMeasuresList.appendChild(newMeasureBlock);
        }
        modalAddMeasureBtn.addEventListener('click', addMeasureInModal);
        function removeMeasureInModal(measureId) { /* ... (unchanged) ... */
            const measureBlock = document.getElementById(measureId); if (measureBlock) { measureBlock.remove(); console.log(`Removed measure block ${measureId} from modal DOM.`); } else { console.warn(`Could not find measure block with ID ${measureId} to remove from modal.`); }
        }
        function toggleLifecycleInput(selectElement, measureId) { /* ... (unchanged) ... */
            const measureBlock = document.getElementById(measureId); if (!measureBlock) return; const lifecycleContainer = measureBlock.querySelector('.lifecycle-input-container'); if (selectElement.value === 'yes') { lifecycleContainer.classList.add('hidden'); } else { lifecycleContainer.classList.remove('hidden'); }
        }
        // ** New function to toggle ramp-up input visibility **
        function toggleRampYearsInput(selectElement, measureId) {
             const measureBlock = document.getElementById(measureId);
             if (!measureBlock) return;
             const rampYearsContainer = measureBlock.querySelector('.ramp-years-input-container');
             if (selectElement.value === 'yes') { // Instant effect = Yes
                 rampYearsContainer.classList.add('hidden');
             } else { // Instant effect = No
                 rampYearsContainer.classList.remove('hidden');
             }
         }


        // --- Tab Switching Logic ---
        function switchTab(tabId) {
            activeTab = tabId;
            // Hide all content
            tabContentDashboard.classList.add('hidden');
            tabContentMacc.classList.add('hidden');
            tabContentWedges.classList.add('hidden'); // Hide new tab
            // Deactivate all buttons
            tabBtnDashboard.classList.remove('active');
            tabBtnMacc.classList.remove('active');
            tabBtnWedges.classList.remove('active'); // Deactivate new button

            // Activate selected tab
            if (tabId === 'dashboard') {
                tabContentDashboard.classList.remove('hidden');
                tabBtnDashboard.classList.add('active');
            } else if (tabId === 'macc') {
                tabContentMacc.classList.remove('hidden');
                tabBtnMacc.classList.add('active');
                 // ** Trigger MACC calculation when tab becomes active **
                 if (isToolInitialized) {
                     console.log("MACC tab activated, recalculating...");
                     debouncedCalculateAllData(); // Use debounce to avoid rapid calls if switching quickly
                 }
            } else if (tabId === 'wedges') { // Activate new tab
                tabContentWedges.classList.remove('hidden');
                tabBtnWedges.classList.add('active');
                 // ** Trigger Wedge calculation when tab becomes active **
                 if (isToolInitialized) {
                     console.log("Wedge tab activated, recalculating...");
                     debouncedCalculateAllData();
                 }
            }
        }

        // --- Page Navigation Logic ---
        // *** Reverted showPage function to use fade ***
        function showPage(pageIdToShow) {
            console.log(`[showPage] Attempting to show: ${pageIdToShow}`);
            const pageToHideId = (pageIdToShow === 'tool-section') ? 'home-section' : 'tool-section';
            const pageToHide = document.getElementById(pageToHideId);
            const pageToShow = document.getElementById(pageIdToShow);

            if (!pageToHide || !pageToShow) {
                console.error(`[showPage] Could not find elements for page transition.`);
                return;
            }

            // Start fading out the current page
            pageToHide.classList.add('fade-out');

            // After fade out duration, hide old page and show new page
            setTimeout(() => {
                pageToHide.classList.add('hidden'); // Use display:none
                pageToHide.classList.remove('fade-out'); // Clean up class

                pageToShow.classList.remove('hidden'); // Make new page take up space
                // Use rAF to ensure display change is rendered before adding active class
                requestAnimationFrame(() => {
                    pageToShow.classList.add('active'); // Trigger fade-in
                    // Scroll tool section into view smoothly if needed
                    if (pageIdToShow === 'tool-section') {
                         pageToShow.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    } else {
                         window.scrollTo(0, 0); // Scroll home to top
                    }
                });

                console.log(`[showPage] Now showing: ${pageIdToShow}`);

            }, 500); // Match the CSS transition duration (0.5s)
        }

        // *** Renamed back to showHomePage for clarity ***
        function showHomePage() {
            showPage('home-section');
        }


        // --- Tool Initialization Function ---
        function initializeTool() {
             if (isToolInitialized) {
                 console.log("[initializeTool] Tool already initialized.");
                 return; // Only run once
             }
             console.log("[initializeTool] Initializing tool...");
             isToolInitialized = true;
             saveBaselineModal(); // Initialize baseline display based on modal defaults
             updateGrowthRateDisplay(); // Initialize growth display based on defaults
             populateMaccYearSelector(); // Populate year selector

             if (scenariosDataStore.length === 0) {
                 addScenario(); // Add default scenario and trigger calculation
             } else {
                 // If data was pre-loaded, render scenarios and calculate
                 scenariosListContainer.innerHTML = '';
                 scenariosDataStore.forEach(sc => { scenariosListContainer.appendChild(createScenarioBlockElement(sc)); });
                 calculateAllData();
             }
             // Attach listeners for elements *inside* the tool section now
             if(addScenarioBtn) { addScenarioBtn.addEventListener('click', addScenario); } else { console.error("Add Scenario button not found during initialization!"); }
             baselineYearInput.addEventListener('input', () => { updateGrowthRateDisplay(); populateMaccYearSelector(); debouncedCalculateAllData(); }); // Update year selector on baseline change
             targetReductionInput.addEventListener('input', debouncedCalculateAllData);
             sbtiCheckbox.addEventListener('change', () => { targetReductionInput.disabled = sbtiCheckbox.checked; sbtiNote.classList.toggle('hidden', !sbtiCheckbox.checked); debouncedCalculateAllData(); });
             maccYearSelect.addEventListener('change', debouncedCalculateAllData); // Recalculate MACC on year change
             console.log("[initializeTool] Initialization complete.");
        }

        // --- MACC Year Selector Population ---
        function populateMaccYearSelector() {
            const startYear = parseInt(baselineYearInput.value) || new Date().getFullYear();
            const endYear = 2050;
            const currentSelectedValue = maccYearSelect.value; // Remember current selection
            maccYearSelect.innerHTML = ''; // Clear existing options
            for (let year = startYear; year <= endYear; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                // Reselect previous value if still valid, otherwise select default
                if (year == currentSelectedValue) {
                     option.selected = true;
                } else if (!currentSelectedValue && year === Math.min(endYear, Math.max(startYear + 1, 2030))) {
                     option.selected = true; // Default selection logic
                }
                maccYearSelect.appendChild(option);
            }
        }


        // --- Home Page Interaction & Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("Page loaded. Tool inactive.");
            // Start with home section visible, tool hidden
            homeSection.classList.remove('hidden');
            toolSection.classList.add('hidden');
            toolSection.classList.remove('active'); // Ensure tool starts transparent

            // Set initial displays based on defaults
            baselineDisplay.textContent = `${(baselineData.scope1 + baselineData.scope2).toFixed(0)} tCO2eq`;
            updateGrowthRateDisplay();
            targetReductionInput.disabled = sbtiCheckbox.checked;
            sbtiNote.classList.toggle('hidden', !sbtiCheckbox.checked);
            populateMaccYearSelector(); // Populate MACC year selector initially

            // ** Attach the home button listener here **
             if (tryToolBtn) {
                 tryToolBtn.addEventListener('click', () => {
                     console.log("[tryToolBtn] Clicked!");
                     showPage('tool-section'); // Switch page using fade
                     // Initialize the tool *after* the page is shown and fade is complete
                     setTimeout(() => {
                        initializeTool();
                     }, 500); // Match the fade transition duration

                 });
                 console.log("Event listener attached to tryToolBtn.");
             } else {
                 console.error("tryToolBtn not found!");
             }

            // Attach other listeners that need the DOM ready but don't trigger calc immediately
             baselineYearInput.addEventListener('input', () => {
                 updateGrowthRateDisplay();
                 populateMaccYearSelector(); // Update MACC year options if baseline year changes
                 if (isToolInitialized) debouncedCalculateAllData();
             });
             targetReductionInput.addEventListener('input', () => {
                 if (isToolInitialized) debouncedCalculateAllData();
             });
             sbtiCheckbox.addEventListener('change', () => {
                 targetReductionInput.disabled = sbtiCheckbox.checked;
                 sbtiNote.classList.toggle('hidden', !sbtiCheckbox.checked);
                 if (isToolInitialized) debouncedCalculateAllData();
             });
             maccYearSelect.addEventListener('change', () => { // Add listener for MACC year select
                 if (isToolInitialized) debouncedCalculateAllData();
             });
             // addScenarioBtn listener is added during initializeTool

        }); // End DOMContentLoaded


         // --- Background Animation ---
         homeSection.addEventListener('mousemove', (e) => {
            const { clientX, clientY } = e;
            const { offsetWidth, offsetHeight } = homeSection;
            const xPercent = (clientX / offsetWidth) * 100;
            const yPercent = (clientY / offsetHeight) * 100;
            homeSection.style.setProperty('--x', `${xPercent}%`);
            homeSection.style.setProperty('--y', `${yPercent}%`);
        });


    </script>

</body>
</html>

